
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>è»’ & ä½©å°ˆå±¬ APP</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <meta name="theme-color" content="#E0C3FC">
    
    <meta name="apple-mobile-web-app-title" content="è»’&ä½©">

    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/peipei021212/PeiPei/refs/heads/main/icon-180.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* é˜²æ­¢ iOS ä¸‹æ‹‰åˆ·æ–°å°è‡´é é¢å½ˆå‹• */
            user-select: none; /* è®“ App æ„Ÿè¦ºæ›´åƒåŸç”Ÿï¼Œé˜²æ­¢é•·æŒ‰é¸å–æ–‡å­— */
            touch-action: manipulation; /* å„ªåŒ–é»æ“Šåæ‡‰é€Ÿåº¦ */
        }
        
        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .glass-dark {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Gradient Background */
        .bg-gradient-main {
            background: linear-gradient(135deg, #E0C3FC 0%, #8EC5FC 100%);
            background-attachment: fixed;
        }

        /* Identity Themes */
        .theme-peipei .accent-color { color: #9F7AEA; }
        .theme-peipei .accent-bg { background-color: #9F7AEA; }
        
        .theme-haoxuan .accent-color { color: #63B3ED; }
        .theme-haoxuan .accent-bg { background-color: #63B3ED; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* Mobile Optimizations */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        /* é é¢åˆ‡æ›æ§åˆ¶ */
        .page-section { display: none; }
        .page-section.active { display: block; }
    </style>
</head>
<body class="bg-gradient-main text-gray-700 h-screen overflow-hidden flex flex-col">

    <div id="loading-screen" class="fixed inset-0 z-[60] flex items-center justify-center bg-white/90 backdrop-blur-sm transition-opacity duration-500">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto mb-4"></div>
            <p class="text-gray-500 font-medium tracking-widest">é€£ç·šä¸­...</p>
        </div>
    </div>

    <div id="login-page" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-6 glass transition-all duration-500">
        <div class="text-center mb-10 transform transition-all duration-500" id="login-header">
            <h1 class="text-4xl font-bold text-gray-800 mb-2 drop-shadow-sm">è»’ & ä½©</h1>
            <p class="text-lg text-gray-600 tracking-widest">å°ˆå±¬ APP</p>
        </div>

        <div class="w-full max-w-sm space-y-6">
            <div class="text-center mb-4 transition-all duration-300" id="user-selection">
                <p class="text-gray-500 text-sm mb-4">è«‹é¸æ“‡æ‚¨çš„èº«ä»½</p>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="window.selectUser('peipei')" id="btn-user-peipei" class="p-6 rounded-2xl bg-white shadow-lg border-2 border-transparent active:scale-95 transition-all transform">
                        <div class="text-4xl mb-2">ğŸ€</div>
                        <div class="font-bold text-gray-700">ä½©ä½©</div>
                    </button>
                    <button onclick="window.selectUser('haoxuan')" id="btn-user-haoxuan" class="p-6 rounded-2xl bg-white shadow-lg border-2 border-transparent active:scale-95 transition-all transform">
                        <div class="text-4xl mb-2">ğŸ»</div>
                        <div class="font-bold text-gray-700">æµ©è»’</div>
                    </button>
                </div>
            </div>

            <div id="pin-section" class="hidden animate-fade-in bg-white/60 p-6 rounded-2xl shadow-lg backdrop-blur-md">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-gray-600 font-bold" id="pin-instruction">è«‹è¼¸å…¥ PIN ç¢¼</p>
                    <button onclick="window.resetLogin()" class="text-xs text-gray-400 p-2">é‡é¸</button>
                </div>
                
                <div class="flex justify-center gap-3 mb-6 relative">
                    <input type="tel" id="pin-input" maxlength="4" 
                           class="text-center text-3xl tracking-[0.5em] font-bold w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-4 focus:ring-purple-200 bg-white/90 shadow-inner text-gray-700" 
                           inputmode="numeric" placeholder="â€¢â€¢â€¢â€¢"
                           oninput="window.checkAutoPin()">
                </div>
                
                <button onclick="window.verifyPin()" id="btn-verify" class="w-full py-3 rounded-xl bg-gray-800 text-white font-bold shadow-md active:scale-95 transition-transform">
                    é€²å…¥æ„›çš„å°çª©
                </button>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden flex-col h-full w-full relative z-10">
        
        <header class="pt-safe px-4 pb-3 glass-dark z-30 flex justify-between items-center shadow-sm">
            <div>
                <h2 class="text-xl font-bold tracking-wide" id="header-title">ä½©ã®å°ˆå±¬</h2>
                <p class="text-[10px] text-gray-500 font-medium" id="current-user-display">Login: ...</p>
            </div>
            <button onclick="window.openSettings()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 transition-colors">
                <i class="fas fa-cog"></i>
            </button>
        </header>

        <main class="flex-1 overflow-y-auto p-4 pb-28 scroll-smooth" id="content-area">
            
            <div id="view-peipei" class="page-section active animate-fade-in space-y-6">
                <section class="bg-white/90 rounded-2xl shadow-sm p-4 backdrop-blur-sm border border-white/50">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                        <h3 class="font-bold text-purple-600 flex items-center gap-2"><i class="fas fa-file-invoice-dollar"></i> å ±éŠ·å€</h3>
                        <button onclick="window.openModal('add-reimburse')" class="text-xs bg-purple-50 text-purple-600 px-3 py-1.5 rounded-full font-bold active:bg-purple-100">+ æ–°å¢</button>
                    </div>
                    <div id="list-reimbursements" class="space-y-3 min-h-[50px]">
                        <p class="text-center text-gray-400 text-sm py-2">è¼‰å…¥ä¸­...</p>
                    </div>
                </section>

                <section class="bg-white/90 rounded-2xl shadow-sm p-4 backdrop-blur-sm border border-white/50">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                        <h3 class="font-bold text-pink-500 flex items-center gap-2"><i class="fas fa-wand-magic-sparkles"></i> ä½©ã®è¨±é¡˜æ± </h3>
                        <button onclick="window.openModal('add-wish-peipei')" class="text-xs bg-pink-50 text-pink-600 px-3 py-1.5 rounded-full font-bold active:bg-pink-100">+ è¨±é¡˜</button>
                    </div>
                    <div id="list-wishes-peipei" class="grid grid-cols-2 gap-3 min-h-[50px]"></div>
                </section>
            </div>

            <div id="view-haoxuan" class="page-section animate-fade-in space-y-6">
                 <section class="bg-white/90 rounded-2xl shadow-sm p-4 backdrop-blur-sm border border-white/50">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                        <h3 class="font-bold text-blue-600 flex items-center gap-2"><i class="fas fa-star"></i> è»’ã®è¨±é¡˜æ± </h3>
                        <button onclick="window.openModal('add-wish-haoxuan')" class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full font-bold active:bg-blue-100">+ è¨±é¡˜</button>
                    </div>
                    <div id="list-wishes-haoxuan" class="grid grid-cols-2 gap-3 min-h-[50px]"></div>
                </section>
            </div>

            <div id="view-family" class="page-section animate-fade-in space-y-6">
                <section class="bg-white/90 rounded-2xl shadow-sm p-4 backdrop-blur-sm border border-white/50">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                        <h3 class="font-bold text-green-600 flex items-center gap-2"><i class="fas fa-shopping-cart"></i> å¾…è³¼æ¸…å–®</h3>
                        <button onclick="window.openModal('add-shopping')" class="text-xs bg-green-50 text-green-600 px-3 py-1.5 rounded-full font-bold active:bg-green-100">+ æ–°å¢</button>
                    </div>
                    <div id="list-shopping" class="space-y-2 min-h-[50px]"></div>
                </section>

                <section class="bg-white/90 rounded-2xl shadow-sm p-4 backdrop-blur-sm border border-white/50">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                        <h3 class="font-bold text-orange-600 flex items-center gap-2"><i class="fas fa-calculator"></i> å®¶åº­è¨˜å¸³</h3>
                        <button onclick="window.openModal('add-expense')" class="text-xs bg-orange-50 text-orange-600 px-3 py-1.5 rounded-full font-bold active:bg-orange-100">+ è¨˜ä¸€ç­†</button>
                    </div>
                    <div class="text-xs text-gray-400 mb-2 flex justify-between px-2">
                        <span>é …ç›®</span>
                        <span>é‡‘é¡</span>
                    </div>
                    <div id="list-expenses" class="space-y-2 max-h-60 overflow-y-auto px-1"></div>
                </section>
            </div>

            <div id="view-dream" class="page-section animate-fade-in space-y-6">
                <section class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl shadow-lg p-6 text-white text-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-20 text-6xl"><i class="fas fa-gem"></i></div>
                    <p class="text-indigo-100 text-sm mb-1 font-medium">ç›®å‰ç´¯ç©åŸºé‡‘</p>
                    <h2 class="text-4xl font-bold tracking-tight mb-6" id="dream-total">---</h2>
                    <button onclick="window.openModal('add-dream')" class="bg-white/20 hover:bg-white/30 active:scale-95 backdrop-blur text-white px-8 py-2.5 rounded-full transition-all font-bold text-sm shadow-inner">
                        å­˜å…¥ / æ”¯å‡º
                    </button>
                </section>

                <section class="bg-white/90 rounded-2xl shadow-sm p-4 backdrop-blur-sm border border-white/50">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2 pb-2 border-b border-gray-100"><i class="fas fa-history"></i> è®Šå‹•ç´€éŒ„</h3>
                    <div id="list-dream" class="space-y-3 min-h-[50px]"></div>
                </section>
            </div>

            <div id="view-requests" class="page-section animate-fade-in space-y-6">
                <section class="bg-white/90 rounded-2xl shadow-sm p-4 backdrop-blur-sm border border-white/50">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                        <h3 class="font-bold text-gray-700 flex items-center gap-2"><i class="fas fa-clipboard-check"></i> éœ€æ±‚ç”³è«‹å–®</h3>
                        <button onclick="window.openModal('add-request')" class="text-xs bg-gray-100 text-gray-700 px-3 py-1.5 rounded-full font-bold active:bg-gray-200">+ æå‡ºç”³è«‹</button>
                    </div>
                    <div id="list-requests" class="space-y-4 min-h-[50px]"></div>
                </section>
            </div>

        </main>

        <nav class="fixed bottom-0 left-0 right-0 glass-dark pb-safe pt-2 px-1 border-t border-white/40 z-40 flex justify-around items-end shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
            <button onclick="window.switchTab('peipei')" class="nav-btn flex flex-col items-center p-2 w-1/5 transition-all duration-200 active:scale-90" id="nav-peipei">
                <span class="text-2xl mb-1 transition-transform">ğŸ€</span>
                <span class="text-[10px] font-medium text-gray-400">ä½©ã®æ¸…å–®</span>
            </button>
            <button onclick="window.switchTab('haoxuan')" class="nav-btn flex flex-col items-center p-2 w-1/5 transition-all duration-200 active:scale-90" id="nav-haoxuan">
                <span class="text-2xl mb-1 transition-transform">ğŸ»</span>
                <span class="text-[10px] font-medium text-gray-400">è»’ã®æ¸…å–®</span>
            </button>
            <button onclick="window.switchTab('family')" class="nav-btn flex flex-col items-center p-2 w-1/5 transition-all duration-200 active:scale-90" id="nav-family">
                <span class="text-2xl mb-1 transition-transform">ğŸ¡</span>
                <span class="text-[10px] font-medium text-gray-400">å®¶åº­é–‹æ”¯</span>
            </button>
            <button onclick="window.switchTab('dream')" class="nav-btn flex flex-col items-center p-2 w-1/5 transition-all duration-200 active:scale-90" id="nav-dream">
                <span class="text-2xl mb-1 transition-transform">ğŸ’</span>
                <span class="text-[10px] font-medium text-gray-400">å¤¢æƒ³åŸºé‡‘</span>
            </button>
            <button onclick="window.switchTab('requests')" class="nav-btn flex flex-col items-center p-2 w-1/5 transition-all duration-200 active:scale-90" id="nav-requests">
                <span class="text-2xl mb-1 transition-transform">ğŸ“</span>
                <span class="text-[10px] font-medium text-gray-400">ç”³è«‹å–®</span>
            </button>
        </nav>
    </div>

    <div id="modal-overlay" class="fixed inset-0 z-[70] bg-black/40 backdrop-blur-sm hidden items-center justify-center p-6 transition-all">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB_ibqjVqz5YGMhNBqDNMTKjoah_cis1x4",
            authDomain: "peipei-9340e.firebaseapp.com",
            projectId: "peipei-9340e",
            storageBucket: "peipei-9340e.firebasestorage.app",
            messagingSenderId: "265456201682",
            appId: "1:265456201682:web:a42736be9dfac54db6620b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'couple-app-v1';

        // State
        let currentUser = null;
        let tempUser = null;
        let defaultPins = { peipei: '0516', haoxuan: '0202' };
        let currentPins = { ...defaultPins };

        // --- Helpers ---
        const getColl = (colName) => collection(db, 'artifacts', appId, 'public', 'data', colName);

        // --- Core Logic Exposed to Window ---
        
        window.selectUser = (user) => {
            tempUser = user;
            document.getElementById('user-selection').style.display = 'none'; // Hide avatars
            document.getElementById('login-header').classList.add('scale-75', '-translate-y-4'); // Shrink header
            
            const pinSec = document.getElementById('pin-section');
            pinSec.classList.remove('hidden');
            
            const btn = document.getElementById('btn-verify');
            const colorClass = user === 'peipei' ? 'bg-purple-500' : 'bg-blue-500';
            btn.className = `w-full py-3 rounded-xl text-white font-bold shadow-md active:scale-95 transition-transform ${colorClass}`;

            document.getElementById('pin-instruction').innerText = `è«‹è¼¸å…¥ ${user === 'peipei' ? 'ä½©ä½©' : 'æµ©è»’'} çš„ PIN ç¢¼`;
            
            const input = document.getElementById('pin-input');
            input.value = '';
            input.focus();
        };

        window.resetLogin = () => {
            document.getElementById('pin-section').classList.add('hidden');
            document.getElementById('user-selection').style.display = 'block';
            document.getElementById('login-header').classList.remove('scale-75', '-translate-y-4');
            document.getElementById('pin-input').value = '';
        };

        window.checkAutoPin = () => {
            const val = document.getElementById('pin-input').value;
            if(val.length === 4) {
                window.verifyPin();
            }
        };

        window.verifyPin = () => {
            const input = document.getElementById('pin-input').value;
            if (input === currentPins[tempUser]) {
                // Success
                const btn = document.getElementById('btn-verify');
                btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> é€²å…¥ä¸­...';
                
                setTimeout(() => {
                    login(tempUser);
                }, 500); // Small delay for visual feedback
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ â¤ï¸");
                document.getElementById('pin-input').value = '';
                document.getElementById('pin-input').focus();
            }
        };

        function login(user) {
            try {
                currentUser = user;
                
                // Theme Logic
                const body = document.body;
                body.className = `bg-gradient-main text-gray-700 h-screen overflow-hidden flex flex-col theme-${user}`;
                
                if (user === 'haoxuan') {
                    body.style.background = 'linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%)';
                } else {
                    body.style.background = 'linear-gradient(135deg, #F3E8FF 0%, #E0E7FF 100%)';
                }

                document.getElementById('current-user-display').innerText = `ç•¶å‰ç™»å…¥: ${user === 'peipei' ? 'ä½©ä½©' : 'æµ©è»’'}`;

                // Force layout switch (Robust method)
                const loginPage = document.getElementById('login-page');
                const mainApp = document.getElementById('main-app');

                loginPage.style.opacity = '0';
                setTimeout(() => {
                    loginPage.style.display = 'none';
                    mainApp.classList.remove('hidden');
                    mainApp.style.display = 'flex';
                    window.switchTab('peipei');
                }, 300);

            } catch (e) {
                console.error("Login Error:", e);
                alert("ç™»å…¥ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†");
            }
        }

        window.switchTab = (tab) => {
            // Title Update
            const titles = {
                'peipei': 'ä½©ã®å°ˆå±¬',
                'haoxuan': 'è»’ã®å°ˆå±¬',
                'family': 'å®¶åº­é–‹æ”¯',
                'dream': 'å¤¢æƒ³åŸºé‡‘',
                'requests': 'éœ€æ±‚ç”³è«‹'
            };
            document.getElementById('header-title').innerText = titles[tab];

            // Toggle Content
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.add('active');

            // Toggle Nav
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.querySelector('span:last-child').classList.replace('text-gray-800', 'text-gray-400');
                btn.querySelector('span:last-child').classList.replace(currentUser === 'peipei' ? 'text-purple-600' : 'text-blue-600', 'text-gray-400');
                btn.querySelector('span:first-child').classList.remove('scale-110');
            });

            const activeBtn = document.getElementById(`nav-${tab}`);
            const activeColor = currentUser === 'peipei' ? 'text-purple-600' : 'text-blue-600';
            const label = activeBtn.querySelector('span:last-child');
            label.classList.remove('text-gray-400');
            label.classList.add(activeColor, 'font-bold');
            activeBtn.querySelector('span:first-child').classList.add('scale-110');
        };

        // --- Modals ---
        window.openModal = (type) => {
            const overlay = document.getElementById('modal-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            
            let content = '';
            const cardClass = "bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl animate-fade-in transform scale-100 transition-all";
            
            if (type === 'add-reimburse') {
                content = `
                    <div class="${cardClass}">
                        <h3 class="font-bold text-lg mb-4 text-center text-purple-600">æ–°å¢å ±éŠ·é …ç›®</h3>
                        <input id="inp-reimb-title" type="text" placeholder="é …ç›®åç¨±" class="w-full mb-3 p-3 bg-purple-50 rounded-xl outline-none focus:ring-2 focus:ring-purple-200">
                        <input id="inp-reimb-amount" type="number" placeholder="é‡‘é¡" class="w-full mb-5 p-3 bg-purple-50 rounded-xl outline-none focus:ring-2 focus:ring-purple-200">
                        <div class="flex gap-3">
                            <button onclick="window.closeModal()" class="flex-1 py-3 text-gray-400 font-bold bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                            <button onclick="window.submitReimburse()" class="flex-1 py-3 bg-purple-500 text-white rounded-xl font-bold shadow-lg shadow-purple-200">æ–°å¢</button>
                        </div>
                    </div>`;
            } else if (type === 'add-wish-peipei' || type === 'add-wish-haoxuan') {
                const isPei = type === 'add-wish-peipei';
                const color = isPei ? 'pink' : 'blue';
                content = `
                    <div class="${cardClass}">
                        <h3 class="font-bold text-lg mb-4 text-center text-${color}-500">è¨±ä¸‹é¡˜æœ› âœ¨</h3>
                        <input id="inp-wish-title" type="text" placeholder="æƒ³è¦ä»€éº¼..." class="w-full mb-5 p-3 bg-${color}-50 rounded-xl outline-none focus:ring-2 focus:ring-${color}-200">
                        <div class="flex gap-3">
                            <button onclick="window.closeModal()" class="flex-1 py-3 text-gray-400 font-bold bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                            <button onclick="window.submitWish('${isPei ? 'peipei_wishes' : 'haoxuan_wishes'}')" class="flex-1 py-3 bg-${color}-500 text-white rounded-xl font-bold shadow-lg shadow-${color}-200">è¨±é¡˜</button>
                        </div>
                    </div>`;
            } else if (type === 'add-shopping') {
                content = `
                    <div class="${cardClass}">
                        <h3 class="font-bold text-lg mb-4 text-center text-green-600">æ–°å¢å¾…è³¼</h3>
                        <input id="inp-shop-item" type="text" placeholder="è²·ä»€éº¼..." class="w-full mb-5 p-3 bg-green-50 rounded-xl outline-none focus:ring-2 focus:ring-green-200">
                        <div class="flex gap-3">
                            <button onclick="window.closeModal()" class="flex-1 py-3 text-gray-400 font-bold bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                            <button onclick="window.submitShopping()" class="flex-1 py-3 bg-green-500 text-white rounded-xl font-bold shadow-lg shadow-green-200">æ–°å¢</button>
                        </div>
                    </div>`;
            } else if (type === 'add-expense') {
                content = `
                    <div class="${cardClass}">
                        <h3 class="font-bold text-lg mb-4 text-center text-orange-600">è¨˜ä¸€ç­†</h3>
                        <input id="inp-exp-title" type="text" placeholder="é …ç›®" class="w-full mb-3 p-3 bg-orange-50 rounded-xl outline-none focus:ring-2 focus:ring-orange-200">
                        <input id="inp-exp-amount" type="number" placeholder="é‡‘é¡" class="w-full mb-5 p-3 bg-orange-50 rounded-xl outline-none focus:ring-2 focus:ring-orange-200">
                        <div class="flex gap-3">
                            <button onclick="window.closeModal()" class="flex-1 py-3 text-gray-400 font-bold bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                            <button onclick="window.submitExpense()" class="flex-1 py-3 bg-orange-500 text-white rounded-xl font-bold shadow-lg shadow-orange-200">ç´€éŒ„</button>
                        </div>
                    </div>`;
            } else if (type === 'add-dream') {
                content = `
                    <div class="${cardClass}">
                        <h3 class="font-bold text-lg mb-4 text-center text-indigo-600">å¤¢æƒ³åŸºé‡‘ ğŸ’</h3>
                        <input id="inp-dream-note" type="text" placeholder="å‚™è¨» (å¦‚: å­˜å…¥è–ªæ°´)" class="w-full mb-3 p-3 bg-indigo-50 rounded-xl outline-none focus:ring-2 focus:ring-indigo-200">
                        <input id="inp-dream-amount" type="number" placeholder="é‡‘é¡ (è² æ•¸ç‚ºæ”¯å‡º)" class="w-full mb-5 p-3 bg-indigo-50 rounded-xl outline-none focus:ring-2 focus:ring-indigo-200">
                        <div class="flex gap-3">
                            <button onclick="window.closeModal()" class="flex-1 py-3 text-gray-400 font-bold bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                            <button onclick="window.submitDream()" class="flex-1 py-3 bg-indigo-500 text-white rounded-xl font-bold shadow-lg shadow-indigo-200">ç¢ºå®š</button>
                        </div>
                    </div>`;
            } else if (type === 'add-request') {
                content = `
                    <div class="${cardClass}">
                        <h3 class="font-bold text-lg mb-4 text-center text-gray-700">æå‡ºç”³è«‹ ğŸ“</h3>
                        <input id="inp-req-title" type="text" placeholder="éœ€æ±‚äº‹é …" class="w-full mb-3 p-3 bg-gray-100 rounded-xl outline-none focus:ring-2 focus:ring-gray-300">
                        <textarea id="inp-req-reason" rows="3" placeholder="åŸå› ..." class="w-full mb-5 p-3 bg-gray-100 rounded-xl outline-none focus:ring-2 focus:ring-gray-300"></textarea>
                        <div class="flex gap-3">
                            <button onclick="window.closeModal()" class="flex-1 py-3 text-gray-400 font-bold bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                            <button onclick="window.submitRequest()" class="flex-1 py-3 bg-gray-800 text-white rounded-xl font-bold shadow-lg">é€å‡º</button>
                        </div>
                    </div>`;
            }
            overlay.innerHTML = content;
        };

        window.closeModal = () => {
            const overlay = document.getElementById('modal-overlay');
            overlay.classList.remove('flex');
            overlay.classList.add('hidden');
        };

        window.openSettings = () => {
             window.openModal('settings'); // Hacky reuse but effective
             const overlay = document.getElementById('modal-overlay');
             overlay.innerHTML = `
                <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl animate-fade-in text-center">
                    <h3 class="font-bold text-lg mb-4">ä¿®æ”¹ PIN ç¢¼</h3>
                    <p class="text-sm text-gray-500 mb-4">ä¿®æ”¹ ${currentUser === 'peipei' ? 'ä½©ä½©' : 'æµ©è»’'} çš„å¯†ç¢¼</p>
                    <input id="inp-new-pin" type="text" maxlength="4" placeholder="æ–° 4 ä½ PIN" class="w-full mb-5 p-3 text-center text-xl tracking-widest bg-gray-50 rounded-xl border border-gray-200 outline-none focus:border-purple-300">
                    <div class="flex gap-3">
                        <button onclick="window.closeModal()" class="flex-1 py-3 text-gray-400 font-bold bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                        <button onclick="window.saveNewPin()" class="flex-1 py-3 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-xl font-bold shadow-lg">å„²å­˜</button>
                    </div>
                </div>`;
        };

        // --- Database Actions ---
        
        window.submitReimburse = async () => {
            if (currentUser !== 'peipei') { alert("åªæœ‰ä½©ä½©å¯ä»¥æ–°å¢å ±éŠ·å–”ï¼"); window.closeModal(); return; }
            const title = document.getElementById('inp-reimb-title').value;
            const amount = document.getElementById('inp-reimb-amount').value;
            if(!title || !amount) return;
            await addDoc(getColl('reimbursements'), { title, amount: parseInt(amount), status: 'pending', date: Date.now() });
            window.closeModal();
        };

        window.submitWish = async (collName) => {
            if (collName === 'peipei_wishes' && currentUser !== 'peipei') { alert("é€™æ˜¯ä½©ä½©çš„è¨±é¡˜æ± ï¼"); return; }
            if (collName === 'haoxuan_wishes' && currentUser !== 'haoxuan') { alert("é€™æ˜¯æµ©è»’çš„è¨±é¡˜æ± ï¼"); return; }
            const title = document.getElementById('inp-wish-title').value;
            if(!title) return;
            await addDoc(getColl(collName), { title, status: 'active', date: Date.now() });
            window.closeModal();
        };

        window.toggleWish = async (coll, id, currentStatus) => {
            const newStatus = currentStatus === 'active' ? 'fulfilled' : 'active';
            await updateDoc(doc(getColl(coll), id), { status: newStatus });
        };

        window.submitShopping = async () => {
            const item = document.getElementById('inp-shop-item').value;
            if(!item) return;
            await addDoc(getColl('shopping_list'), { item, checked: false, date: Date.now() });
            window.closeModal();
        };

        window.toggleCheck = async (coll, id, checked) => {
            await updateDoc(doc(getColl(coll), id), { checked });
        };

        window.submitExpense = async () => {
            const title = document.getElementById('inp-exp-title').value;
            const amount = document.getElementById('inp-exp-amount').value;
            if(!title || !amount) return;
            await addDoc(getColl('family_expenses'), { title, amount: parseInt(amount), date: Date.now() });
            window.closeModal();
        };

        window.submitDream = async () => {
            const note = document.getElementById('inp-dream-note').value;
            const amount = document.getElementById('inp-dream-amount').value;
            if(!note || !amount) return;
            await addDoc(getColl('dream_fund'), { note, amount: parseInt(amount), date: Date.now() });
            window.closeModal();
        };

        window.submitRequest = async () => {
            const title = document.getElementById('inp-req-title').value;
            const reason = document.getElementById('inp-req-reason').value;
            if(!title) return;
            await addDoc(getColl('requests'), { title, reason, status: 'pending', requester: currentUser, date: Date.now() });
            window.closeModal();
        };

        window.updateRequest = async (id, status) => {
            await updateDoc(doc(getColl('requests'), id), { status });
        };

        window.payReimburse = async (id) => {
            if(confirm("ç¢ºå®šè¦æ ¸éŠ·æ­¤é …ç›®å—ï¼Ÿ")) {
                await updateDoc(doc(getColl('reimbursements'), id), { status: 'paid' });
            }
        };

        window.deleteItem = async (coll, id) => {
            if(confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) {
                await deleteDoc(doc(getColl(coll), id));
            }
        };

        window.saveNewPin = async () => {
            const newPin = document.getElementById('inp-new-pin').value;
            if(!newPin || newPin.length !== 4) { alert("è«‹è¼¸å…¥ 4 ä½æ•¸ PIN ç¢¼"); return; }
            const updates = {};
            updates[currentUser] = newPin;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), updates, { merge: true });
            currentPins[currentUser] = newPin;
            alert("å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼");
            window.closeModal();
        };

        // --- Initialization ---
        async function init() {
            try {
                await signInAnonymously(auth);
                const screen = document.getElementById('loading-screen');
                screen.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => screen.style.display = 'none', 500);

                // Load PINs
                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config');
                onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) currentPins = docSnap.data();
                    else setDoc(settingsRef, defaultPins);
                });

                startListeners();
            } catch (e) {
                console.error("Init failed", e);
                alert("ç¶²è·¯é€£ç·šä¼¼ä¹æœ‰å•é¡Œï¼Œè«‹é‡æ–°æ•´ç†è©¦è©¦");
            }
        }

        function startListeners() {
            // Reimbursements
            onSnapshot(query(getColl('reimbursements'), orderBy('date', 'desc')), snap => {
                const list = document.getElementById('list-reimbursements');
                if(snap.empty) { list.innerHTML = '<p class="text-center text-gray-300 text-sm py-4">ç›®å‰æ²’æœ‰é …ç›®</p>'; return; }
                list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const isPaid = data.status === 'paid';
                    const canAction = currentUser === 'haoxuan' && !isPaid;
                    list.innerHTML += `
                        <div class="bg-white border-l-[6px] ${isPaid ? 'border-gray-300 bg-gray-50' : 'border-purple-400'} rounded-xl p-3 shadow-sm flex justify-between items-center transition-all">
                            <div class="${isPaid ? 'opacity-50' : ''}">
                                <div class="font-bold text-gray-800">${data.title}</div>
                                <div class="text-sm text-gray-500 font-medium">$${data.amount} <span class="text-[10px] ml-1 bg-gray-100 px-1 rounded">${new Date(data.date).toLocaleDateString()}</span></div>
                            </div>
                            ${canAction ? `<button onclick="window.payReimburse('${d.id}')" class="bg-blue-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-md shadow-blue-200 active:scale-95 transition-transform">æ ¸éŠ·</button>` : 
                              (isPaid ? `<span class="text-green-500 text-xs font-bold bg-green-50 px-2 py-1 rounded-lg border border-green-100"><i class="fas fa-check"></i> å·²æ ¸éŠ·</span>` : 
                              `<button onclick="window.deleteItem('reimbursements', '${d.id}')" class="text-gray-300 hover:text-red-400 p-2"><i class="fas fa-trash"></i></button>`)}
                        </div>`;
                });
            });

            // Wishes Render Logic
            const renderWishes = (snap, elId, owner) => {
                const list = document.getElementById(elId);
                if(snap.empty) { list.innerHTML = '<p class="col-span-2 text-center text-gray-300 text-sm py-4">é‚„æ²’æœ‰é¡˜æœ›å–”</p>'; return; }
                list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const isFulfilled = data.status === 'fulfilled';
                    const isOwner = currentUser === owner;
                    const color = owner === 'peipei' ? 'pink' : 'blue';
                    list.innerHTML += `
                        <div onclick="${isOwner ? `window.toggleWish('${owner}_wishes', '${d.id}', '${data.status}')` : ''}" 
                             class="aspect-square relative flex flex-col items-center justify-center p-3 rounded-2xl shadow-sm transition-all border border-gray-100
                             ${isFulfilled ? 'bg-gray-50' : 'bg-white'} 
                             ${isOwner ? 'cursor-pointer active:scale-95 active:shadow-inner' : ''}">
                             
                            ${isFulfilled ? '<div class="absolute inset-0 z-10 flex items-center justify-center bg-white/60 backdrop-blur-[1px] rounded-2xl"><span class="text-lg font-bold text-green-500 transform -rotate-12 border-2 border-green-500 px-2 py-1 rounded shadow-sm bg-white">GET!</span></div>' : ''}
                            
                            <i class="fas fa-gift text-3xl mb-3 ${isFulfilled ? 'text-gray-300' : `text-${color}-400 drop-shadow-sm`}"></i>
                            <span class="text-center font-bold text-sm leading-tight text-gray-600 ${isFulfilled ? 'line-through opacity-50' : ''}">${data.title}</span>
                            ${isOwner ? `<button onclick="event.stopPropagation(); window.deleteItem('${owner}_wishes', '${d.id}')" class="absolute top-1 right-1 text-gray-200 hover:text-red-400 p-2 z-20"><i class="fas fa-times"></i></button>` : ''}
                        </div>`;
                });
            };
            onSnapshot(query(getColl('peipei_wishes'), orderBy('date', 'desc')), snap => renderWishes(snap, 'list-wishes-peipei', 'peipei'));
            onSnapshot(query(getColl('haoxuan_wishes'), orderBy('date', 'desc')), snap => renderWishes(snap, 'list-wishes-haoxuan', 'haoxuan'));

            // Shopping List
            onSnapshot(query(getColl('shopping_list'), orderBy('date', 'desc')), snap => {
                const list = document.getElementById('list-shopping');
                if(snap.empty) { list.innerHTML = '<p class="text-center text-gray-300 text-sm py-4">æ¸…å–®æ˜¯ç©ºçš„</p>'; return; }
                list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    list.innerHTML += `
                        <div class="flex items-center bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                            <div class="relative flex items-center">
                                <input type="checkbox" ${data.checked ? 'checked' : ''} onchange="window.toggleCheck('shopping_list', '${d.id}', this.checked)" class="peer w-6 h-6 rounded border-2 border-gray-300 checked:bg-green-500 checked:border-green-500 transition-colors">
                                <i class="fas fa-check text-white absolute left-1 top-1.5 text-xs pointer-events-none opacity-0 peer-checked:opacity-100"></i>
                            </div>
                            <span class="ml-3 flex-1 font-medium transition-all ${data.checked ? 'line-through text-gray-300' : 'text-gray-700'}">${data.item}</span>
                            <button onclick="window.deleteItem('shopping_list', '${d.id}')" class="text-gray-300 hover:text-red-400 p-2"><i class="fas fa-trash"></i></button>
                        </div>`;
                });
            });

            // Family Expenses
            onSnapshot(query(getColl('family_expenses'), orderBy('date', 'desc')), snap => {
                const list = document.getElementById('list-expenses');
                if(snap.empty) { list.innerHTML = '<p class="text-center text-gray-300 text-sm py-4">å°šç„¡ç´€éŒ„</p>'; return; }
                list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    list.innerHTML += `
                        <div class="flex justify-between items-center py-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 px-2 rounded-lg transition-colors">
                            <span class="text-gray-700 font-medium">${data.title}</span>
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-gray-800">$${data.amount}</span>
                                <button onclick="window.deleteItem('family_expenses', '${d.id}')" class="text-gray-200 hover:text-red-400"><i class="fas fa-times"></i></button>
                            </div>
                        </div>`;
                });
            });

            // Dream Fund
            onSnapshot(query(getColl('dream_fund'), orderBy('date', 'desc')), snap => {
                const list = document.getElementById('list-dream');
                let total = 0;
                list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const amount = parseInt(data.amount);
                    total += amount;
                    const isDeposit = amount > 0;
                    list.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-white rounded-xl shadow-sm border-l-4 ${isDeposit ? 'border-indigo-400' : 'border-pink-400'}">
                            <div>
                                <div class="font-bold text-gray-800">${data.note}</div>
                                <div class="text-[10px] text-gray-400">${new Date(data.date).toLocaleDateString()}</div>
                            </div>
                            <span class="font-bold ${isDeposit ? 'text-indigo-600' : 'text-pink-600'}">${amount > 0 ? '+' : ''}${amount}</span>
                        </div>`;
                });
                document.getElementById('dream-total').innerText = `NT$ ${total.toLocaleString()}`;
            });

            // Requests
            onSnapshot(query(getColl('requests'), orderBy('date', 'desc')), snap => {
                const list = document.getElementById('list-requests');
                if(snap.empty) { list.innerHTML = '<p class="text-center text-gray-300 text-sm py-4">ç„¡ç”³è«‹ç´€éŒ„</p>'; return; }
                list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const isApprover = (data.requester === 'peipei' && currentUser === 'haoxuan') || (data.requester === 'haoxuan' && currentUser === 'peipei');
                    const statusConfig = { 
                        'pending': { color: 'bg-yellow-100 text-yellow-700', text: 'å¾…ç°½æ ¸' }, 
                        'approved': { color: 'bg-green-100 text-green-700', text: 'å·²åŒæ„' }, 
                        'rejected': { color: 'bg-red-100 text-red-700', text: 'å·²é€€å›' } 
                    };
                    const config = statusConfig[data.status] || statusConfig['pending'];
                    
                    let actionButtons = '';
                    if (data.status === 'pending' && isApprover) {
                        actionButtons = `
                            <div class="flex gap-2 mt-3 pt-3 border-t border-gray-100">
                                <button onclick="window.updateRequest('${d.id}', 'approved')" class="flex-1 bg-green-500 text-white py-2 rounded-lg text-sm font-bold shadow shadow-green-200">åŒæ„</button>
                                <button onclick="window.updateRequest('${d.id}', 'rejected')" class="flex-1 bg-red-400 text-white py-2 rounded-lg text-sm font-bold shadow shadow-red-200">å©‰æ‹’</button>
                            </div>`;
                    }

                    list.innerHTML += `
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 px-3 py-1 rounded-bl-xl text-xs font-bold ${config.color}">
                                ${config.text}
                            </div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xl">${data.requester === 'peipei' ? 'ğŸ€' : 'ğŸ»'}</span>
                                <span class="font-bold text-gray-800">${data.title}</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-2 bg-gray-50 p-3 rounded-lg leading-relaxed">${data.reason}</p>
                            <div class="text-[10px] text-gray-400 text-right">${new Date(data.date).toLocaleDateString()}</div>
                            ${actionButtons}
                        </div>`;
                });
            });
        }

        init();
    </script>
</body>
</html>
